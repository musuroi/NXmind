# MindMap.tsx 方法整理

## 核心布局与渲染方法

### calculateLayout()
- **功能**: 使用 D3.js 计算思维导图的树状布局
- **计算内容**: 节点宽度、位置和间距
- **缓存**: 更新 layoutCache 以供框选功能使用

### renderTreeLinks()
- **功能**: 渲染节点之间的连接线
- **处理**: 连接线的动画和颜色
- **工具**: 使用 D3.js 选择器管理 SVG 路径

## 视图控制方法

### centerView()
- **功能**: 将指定节点或根节点居中显示
- **处理**: 横竖屏不同的居中逻辑
- **更新**: 视图状态

### 自动平移逻辑 (useEffect)
- **功能**: 编辑节点时自动调整视图确保节点可见
- **限制**: 防止编辑节点超出视口边界

## 节点操作方法

### handleTextChange()
- **功能**: 实时更新节点文本内容
- **特点**: 使用静默更新避免触发历史记录

### handleTextBlur()
- **功能**: 文本失焦时保存到历史记录

### addChild()
- **功能**: 为指定节点添加子节点
- **后续**: 自动进入编辑模式并聚焦新节点

### addSibling()
- **功能**: 为当前节点添加兄弟节点
- **特殊**: 处理根节点的特殊情况

### deleteNode()
- **功能**: 删除指定节点
- **后续**: 自动聚焦到父节点或兄弟节点

### batchDelete()
- **功能**: 批量删除选中的节点
- **处理**: 焦点转移逻辑

## 键盘交互方法

### handleKeyDown()
- **功能**: 处理节点的键盘操作
- **支持**: 导航、编辑、删除等快捷键
- **特殊**: 实现双击方向键导航

### handleInputSelect()
- **功能**: 根据光标位置改变插入符颜色
- **提示**: 提示用户可以导航的方向

## 框选功能方法

### handleMouseDown()
- **功能**: 开始框选操作
- **处理**: 清除或保持现有选择

### handleMouseMove()
- **功能**: 更新框选区域
- **计算**: 实时计算与节点的交集

### handleMouseUp()
- **功能**: 结束框选操作

### getLocalPoint()
- **功能**: 获取相对于容器的鼠标坐标
- **修复**: 修复坐标系跳变问题

## 拖拽功能方法

### handleDragStart()
- **功能**: 开始拖拽节点或节点组
- **设置**: 拖拽效果和隐藏原节点

### handleDragEnd()
- **功能**: 结束拖拽操作
- **清理**: 清理拖拽状态

### handleDragOver()
- **功能**: 处理拖拽悬停
- **计算**: 放置位置和验证有效性

### handleDrop()
- **功能**: 执行节点移动操作
- **支持**: 单节点和批量移动

## 点击与选择方法

### handleNodeClick()
- **功能**: 处理节点点击事件
- **支持**: 单选、多选和编辑模式

## 辅助功能

### getDropPosition()
- **功能**: 根据鼠标位置判断拖放目标位置
- **区分**: 内部、前、后三种位置

### 全局键盘事件处理 (useEffect)
- **功能**: 处理撤销/重做快捷键
- **功能**: 处理批量删除快捷键

### ESC 键处理 (useEffect)
- **功能**: 重置选择和编辑状态
- **返回**: 返回根节点视图

## 状态管理

### 核心状态
- `editingId`: 当前编辑的节点ID
- `selectedIds`: 选中的节点ID集合
- `isSelecting`: 是否正在框选
- `selectionRect`: 框选区域
- `draggedNodeId`: 正在拖拽的节点ID
- `dropTarget`: 拖放目标状态

### 历史记录
- `internalData`: 内部数据状态
- `setInternalDataWithHistory`: 带历史记录的状态更新
- `setInternalDataSilent`: 静默状态更新

## 交互特性

1. **框选**: 支持矩形框选多个节点
2. **拖拽**: 支持单个和批量节点拖拽移动
3. **键盘导航**: 方向键、Tab、Enter 等快捷键
4. **缩放平移**: D3.js 提供的画布缩放和平移
5. **自动聚焦**: 编辑时自动调整视图
6. **多选**: Ctrl/Cmd + 点击多选节点

## 性能优化

1. **布局缓存**: 缓存节点布局信息
2. **条件渲染**: 根据状态条件渲染组件
3. **事件防抖**: 避免频繁的状态更新
4. **历史记录**: 撤销/重做功能